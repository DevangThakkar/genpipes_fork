[TOC]


RNA-Seq Pipeline
================

The standard MUGQIC RNA-Seq pipeline uses [STAR](https://code.google.com/p/rna-star/) to align reads
to the reference genome and discover transcript splice sites. These alignments are used during
downstream analysis in several ways. [Cufflinks](http://cufflinks.cbcb.umd.edu/) uses this map
against the reference genome to assemble the reads into transcripts. Cufflinks is executed in two different ways:

* Cufflinks_denovo: Cufflinks construct a parsimonious set of transcripts that "explain" the reads
observed in the RNA-Seq experiment.
* Cufflinks_known: A reference annotation file is supplied to estimate isoform expression.
Cufflinks will not assemble novel transcripts, and the program will ignore alignments not structurally
compatible with any reference transcript.

Cuffdiff, a part of the Cufflinks package, takes the aligned reads from two conditions and reports transcripts
that are differentially expressed. FPKM values calculated by cufflinks are used as input of
the differential transcript expression analysis. This differences are reported in the isoform_exp.diff.with.fpkm.csv    files located in the cuffdiff_denovo and cuffdiff_known directories, one directory per design.
Otherwise, differential gene expression uses raw read counts generated by HTSeq as input.
The *DESeq* and *edgeR* methods model **count data** by a negative binomial distribution. The parameters
of the distribution (mean and dispersion) are estimated from the data, i.e. from the read counts
in the input files. Both methods compute a measure of read abundance, i.e. expression level (called
*base mean* or *mean of normalized counts* in DESeq, and *concentration* in edgeR) for each gene
and apply a hypothesis test to each gene to evaluate differential expression. In particular,
both methods determine a p-value and a log2 fold change (in expression level) for each gene.
The Log2 FC of EdgeR is reported in the differential gene results file, one file per design.

The log2fold change is the logarithm (to basis 2) of the fold change condition from condition A to B
(mutation or treatment are the most common conditions). A "fold change" between conditions A and B
at a gene or transcript is normally computed as the ratio at gene or transcript of the base mean
of scaled counts for condition B to the base mean of scaled counts for condition A. Counts are scaled
by a size factor in a step called normalisation (if the counts of non-differentially expressed genes
in one sample are, on average, twice as high as in another, the size factor for the first sample
should be twice that of the other sample). Each column of the count table is then divided
by the size factor for this column and the count values are brought to a common scale, making them comparable.
See the [EdgeR vignette](http://www.bioconductor.org/packages/2.12/bioc/vignettes/edgeR/inst/doc/edgeR.pdf)
for additional information on normalization approaches used in the pipeline.

A summary html report is automatically generated by the pipeline. This report contains description
of the sequencing experiment as well as a detailed presentation of the pipeline steps and results.
Various Quality Control (QC) summary statistics are included in the report and additional QC analysis
is accessible for download directly through the report. The report includes also the main references
of the software and methods used during the analysis, together with the full list of parameters
that have been passed to the pipeline main script.

An example of the RNA-Seq report for an analysis on Public Corriel CEPH B-cell is available for illustration
purpose only: [RNA-Seq report](http://gqinnovationcenter.com/services/bioinformatics/tools/rnaReport/index.html).

[Here](https://bitbucket.org/mugqic/mugqic_pipelines/downloads/MUGQIC_Bioinfo_RNA-Seq.pptx) is more
information about RNA-Seq pipeline that you may find interesting.


Usage
-----
```
#!text

usage: rnaseq.py [-h] [--help] [-c CONFIG [CONFIG ...]] [-s STEPS]
                 [-o OUTPUT_DIR] [-j {pbs,batch}] [-f] [--clean]
                 [-l {debug,info,warning,error,critical}] [-d DESIGN]
                 [-r READSETS] [-v]

Version: 2.0.1

For more documentation, visit our website: https://bitbucket.org/mugqic/mugqic_pipelines/

optional arguments:
  -h                    show this help message and exit
  --help                show detailed description of pipeline and steps
  -c CONFIG [CONFIG ...], --config CONFIG [CONFIG ...]
                        config INI-style list of files; config parameters are
                        overwritten based on files order
  -s STEPS, --steps STEPS
                        step range e.g. '1-5', '3,6,7', '2,4-8'
  -o OUTPUT_DIR, --output-dir OUTPUT_DIR
                        output directory (default: current)
  -j {pbs,batch}, --job-scheduler {pbs,batch}
                        job scheduler type (default: pbs)
  -f, --force           force creation of jobs even if up to date (default:
                        false)
  --clean               create 'rm' commands for all job removable files in
                        the given step range, if they exists; if --clean is
                        set, --job-scheduler, --force options and job up-to-
                        date status are ignored (default: false)
  -l {debug,info,warning,error,critical}, --log {debug,info,warning,error,critical}
                        log level (default: info)
  -d DESIGN, --design DESIGN
                        design file
  -r READSETS, --readsets READSETS
                        readset file
  -v, --version         show the version information and exit

Steps:
------
1- picard_sam_to_fastq
2- trimmomatic
3- merge_trimmomatic_stats
4- star
5- picard_merge_sam_files
6- picard_sort_sam
7- picard_mark_duplicates
8- rnaseqc
9- wiggle
10- raw_counts
11- raw_counts_metrics
12- cufflinks
13- cuffmerge
14- cuffquant
15- cuffdiff
16- cuffnorm
17- differential_expression
18- differential_expression_goseq
19- gq_seq_utils_exploratory_analysis_rnaseq
20- gq_seq_utils_report

```
1- picard_sam_to_fastq
----------------------
Convert SAM/BAM files from the input readset file into FASTQ format
if FASTQ files are not already specified in the readset file. Do nothing otherwise.

2- trimmomatic
--------------
Raw reads quality trimming and removing of Illumina adapters is performed using [Trimmomatic](http://www.usadellab.org/cms/index.php?page=trimmomatic).

This step takes as input files:

1. FASTQ files from the readset file if available
2. Else, FASTQ output files from previous picard_sam_to_fastq conversion of BAM files

3- merge_trimmomatic_stats
--------------------------
The trim statistics per readset are merged at this step.

4- star
-------
The filtered reads are aligned to a reference genome. The alignment is done per readset of sequencing
using the [STAR](https://code.google.com/p/rna-star/) software. It generates a Binary Alignment Map file (.bam).

This step takes as input files:

1. Trimmed FASTQ files if available
2. Else, FASTQ files from the readset file if available
3. Else, FASTQ output files from previous picard_sam_to_fastq conversion of BAM files

5- picard_merge_sam_files
-------------------------
BAM readset files are merged into one file per sample. Merge is done using [Picard](http://broadinstitute.github.io/picard/).

6- picard_sort_sam
------------------
The alignment file is reordered (karyotypic) using [Picard](http://broadinstitute.github.io/picard/).

7- picard_mark_duplicates
-------------------------
Mark duplicates. Aligned reads per sample are duplicates if they have the same 5' alignment positions
(for both mates in the case of paired-end reads). All but the best pair (based on alignment score)
will be marked as a duplicate in the BAM file. Marking duplicates is done using [Picard](http://broadinstitute.github.io/picard/).

8- rnaseqc
----------
Computes a series of quality control metrics using [RNA-SeQC](https://www.broadinstitute.org/cancer/cga/rna-seqc).

9- wiggle
---------
Generate wiggle tracks suitable for multiple browsers.

10- raw_counts
--------------
Count reads in features using [htseq-count](http://www-huber.embl.de/users/anders/HTSeq/doc/count.html).

11- raw_counts_metrics
----------------------
Create rawcount matrix, zip the wiggle tracks and create the saturation plots based on standardized read counts.

12- cufflinks
-------------
Compute RNA-Seq data expression using [cufflinks](http://cole-trapnell-lab.github.io/cufflinks/cufflinks/).

13- cuffmerge
-------------
Merge assemblies into a master transcriptome using [cuffmerge](http://cole-trapnell-lab.github.io/cufflinks/cuffmerge/).

14- cuffquant
-------------
Compute gene and transcript expression profiles using [cuffquant](http://cole-trapnell-lab.github.io/cufflinks/cuffquant/).

15- cuffdiff
------------
[Cuffdiff](http://cole-trapnell-lab.github.io/cufflinks/cuffdiff/), the transcript quantification engine
of Cufflinks, is used to calculate transcript expression levels in more than one condition
and test them for significant differences.

16- cuffnorm
------------
Normalize RNA-Seq expression levels using [Cuffnorm](http://cole-trapnell-lab.github.io/cufflinks/cuffnorm/).

17- differential_expression
---------------------------
Performs differential gene expression analysis using [DESEQ](http://bioconductor.org/packages/release/bioc/html/DESeq.html) and [EDGER](http://www.bioconductor.org/packages/release/bioc/html/edgeR.html).
Merge the results of the analysis in a single csv file.

18- differential_expression_goseq
---------------------------------
Gene Ontology analysis for RNA-seq using the bioconductor's R package [goseq](http://www.bioconductor.org/packages/release/bioc/html/goseq.html).
Generates GO annotations for differential gene expression analysis.

19- gq_seq_utils_exploratory_analysis_rnaseq
--------------------------------------------
Exploratory analysis using the gqSeqUtils R package.

20- gq_seq_utils_report
-----------------------
Generates the standard report. A summary html report contains the description of
the sequencing experiment as well as a detailed presentation of the pipeline steps and results.
Various Quality Control (QC) summary statistics are included in the report and additional QC analysis
is accessible for download directly through the report. The report includes also the main references
of the software and methods used during the analysis, together with the full list of parameters
passed to the pipeline main script.


